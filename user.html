<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Info | Í∏Ä‚ÄëBridge</title>
  <meta name="description" content="User account information and token balance for Í∏Ä‚ÄëBridge" />
  <style>
    /* --- Reset & Base --- */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif;line-height:1.65;color:#0f172a;background:linear-gradient(180deg,#f8fafc, #eef2ff)}
    img{max-width:100%;display:block}
    a{color:inherit;text-decoration:none}
    
    /* --- Layout --- */
    .container{max-width:800px;margin-inline:auto;padding:48px 24px}
    header{display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .nav-links{display:flex;gap:24px;align-items:center}
    .nav-links a{color:#6b7280;font-weight:600}
    .nav-links a:hover{color:#111827}
    .logo-icon{width:22px;height:22px;object-fit:contain}
    
    /* --- User Page Specific --- */
    .user-container{max-width:600px;margin:0 auto;padding:24px 0}
    .user-card{background:#ffffff;border-radius:16px;padding:32px;box-shadow:0 4px 6px rgba(0,0,0,0.05);border:1px solid #e5e7eb;margin-bottom:24px}
    .user-header{text-align:center;margin-bottom:32px}
    .user-header h1{font-size:32px;margin:0 0 8px;color:#4c1d95}
    .user-header p{color:#6b7280;margin:0}
    
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px}
    .info-item{text-align:center;padding:20px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb}
    .info-item .label{font-size:14px;color:#6b7280;margin-bottom:8px}
    .info-item .value{font-size:24px;font-weight:700;color:#111827}
    .info-item.balance .value{color:#059669}
    .info-item.used .value{color:#dc2626}
    
    .user-details{margin-top:24px}
    .detail-row{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #f1f5f9}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:#6b7280;font-weight:500}
    .detail-value{color:#111827;font-weight:600}
    
    .loading{text-align:center;padding:40px;color:#6b7280}
    .error{text-align:center;padding:40px;color:#dc2626;background:#fef2f2;border-radius:12px;border:1px solid #fecaca}
    
    .refresh-btn{background:linear-gradient(135deg,#8b5cf6,#4f46e5);color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;margin-top:24px}
    .refresh-btn:hover{opacity:0.9}
    
    /* --- Delete Button Styles --- */
    .delete-btn{background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s}
    .delete-btn:hover{opacity:0.9;transform:translateY(-1px)}
    
    /* --- Modal Styles --- */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6);backdrop-filter:blur(2px)}
    .modal-content{background-color:#fff;margin:10% auto;padding:32px;border-radius:16px;width:90%;max-width:500px;box-shadow:0 20px 40px rgba(0,0,0,0.3);animation:modalSlideIn 0.3s ease-out}
    
    @keyframes modalSlideIn{
      from{transform:translateY(-50px);opacity:0}
      to{transform:translateY(0);opacity:1}
    }
    
    .modal-header{text-align:center;margin-bottom:24px}
    .modal-header h2{color:#dc2626;margin:0 0 8px;font-size:28px}
    .modal-header p{color:#6b7280;margin:0;font-size:16px}
    
    .warning-box{background:#fef2f2;padding:20px;border-radius:12px;border:1px solid #fecaca;margin:20px 0}
    .warning-box p{margin:0 0 8px;color:#991b1b;font-weight:600}
    .warning-box ul{margin:8px 0 0 0;color:#991b1b}
    
    .confirm-input{width:100%;padding:14px;border:2px solid #d1d5db;border-radius:8px;margin:16px 0;font-size:16px;transition:border-color 0.2s}
    .confirm-input:focus{outline:none;border-color:#dc2626}
    .confirm-input.valid{border-color:#059669}
    
    .modal-buttons{display:flex;gap:12px;justify-content:center;margin-top:24px}
    .confirm-btn{background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;border:none;padding:14px 28px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s}
    .cancel-btn{background:#6b7280;color:#fff;border:none;padding:14px 28px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s}
    .confirm-btn:hover:not(:disabled),.cancel-btn:hover{opacity:0.9;transform:translateY(-1px)}
    .confirm-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
  </style>
</head>
<body>
  <header class="container">
    <a href="index.html" class="brand">
      <img src="logo.png" alt="geul-bridge logo" class="logo-icon">
      <span class="logo-title">geul-bridge</span>
    </a>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="about.html">About App</a>
      <a href="login.html">Login</a>
      <a href="user.html" style="color: #8b5cf6; font-weight: 700;">User</a>
    </nav>
  </header>

  <main class="container">
    <div class="user-container">
      
      <!-- Loading State -->
      <div id="loading" class="loading">
        <p>Loading user information...</p>
      </div>
      
      <!-- Error State -->
      <div id="error" class="error" style="display: none;">
        <p id="error-message">Unable to load information.</p>
        <button class="refresh-btn" onclick="loadUserInfo()">Try Again</button>
      </div>
      
      <!-- User Information -->
      <div id="user-info" style="display: none;">
        <div class="user-card">
          <div class="user-header">
            <h1>üë§ User Information</h1>
            <p id="user-email">Loading email...</p>
          </div>
          
          <div class="info-grid">
            <div class="info-item balance">
              <div class="label">üí∞ Remaining Tokens</div>
              <div class="value" id="balance">-</div>
            </div>
            <div class="info-item used">
              <div class="label">üìä Used Tokens</div>
              <div class="value" id="total-used">-</div>
            </div>
          </div>
          
          <div class="user-details">
            <div class="detail-row">
              <span class="detail-label">Email</span>
              <span class="detail-value" id="detail-email">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Join Date</span>
              <span class="detail-value" id="created-at">-</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Last Login</span>
              <span class="detail-value" id="last-login">-</span>
            </div>
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 24px;">
            <button class="refresh-btn" onclick="loadUserInfo()">üîÑ Refresh Info</button>
            <button class="delete-btn" onclick="showDeleteModal()">üóëÔ∏è Delete Account</button>
          </div>
        </div>
      </div>
      
      <!-- Delete Account Modal -->
      <div id="deleteModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>‚ö†Ô∏è Delete Account</h2>
            <p>This action cannot be undone and will be processed immediately.</p>
          </div>
          
          <div class="warning-box">
            <p>‚ö†Ô∏è This will permanently delete:</p>
            <ul>
              <li>Your account and login access</li>
              <li>All remaining tokens</li>
              <li>Translation history and usage data</li>
              <li>All personal information</li>
            </ul>
            <p style="margin-top: 12px; font-size: 14px;">
              üìÖ Your data will be completely removed from our servers within 30 days as per our privacy policy.
            </p>
          </div>
          
          <div style="color: #374151; margin: 16px 0;">
            <p style="margin: 0 0 8px;">To confirm deletion, please type <strong style="color: #dc2626;">DELETE</strong> below:</p>
            <input type="text" id="confirmInput" class="confirm-input" 
                   placeholder="Type DELETE here" autocomplete="off">
          </div>
          
          <div class="modal-buttons">
            <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
            <button class="confirm-btn" onclick="confirmDelete()" id="confirmDeleteBtn" disabled>
              Delete My Account
            </button>
          </div>
        </div>
      </div>
      
    </div>
  </main>

  <script>
    // Get user email from localStorage
    function getCurrentUserEmail() {
      return localStorage.getItem('user_email') || sessionStorage.getItem('user_email');
    }
    
    // Date format function
    function formatDate(dateString) {
      if (!dateString) return '-';
      try {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateString;
      }
    }
    
    // Load user information
    async function loadUserInfo() {
      const email = getCurrentUserEmail();
      
      if (!email) {
        showError('Login required. Please go to the login page.');
        return;
      }
      
      console.log('Loading user info for email:', email); // ÎîîÎ≤ÑÍπÖÏö©
      showLoading();
      
      try {
        const url = `https://us-central1-deductive-ship-470913-d7.cloudfunctions.net/getUserInfo?email=${encodeURIComponent(email)}`;
        console.log('Fetching URL:', url); // ÎîîÎ≤ÑÍπÖÏö©
        
        const response = await fetch(url);
        console.log('Response status:', response.status); // ÎîîÎ≤ÑÍπÖÏö©
        console.log('Response headers:', response.headers); // ÎîîÎ≤ÑÍπÖÏö©
        
        if (!response.ok) {
          const errorText = await response.text();
          console.log('Error response text:', errorText); // ÎîîÎ≤ÑÍπÖÏö©
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const responseText = await response.text();
        console.log('Raw response text:', responseText); // ÎîîÎ≤ÑÍπÖÏö©
        
        let data;
        try {
          data = JSON.parse(responseText);
          console.log('Parsed response data:', data); // ÎîîÎ≤ÑÍπÖÏö©
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          throw new Error(`Invalid JSON response: ${responseText}`);
        }
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        // Display information
        document.getElementById('user-email').textContent = data.email;
        document.getElementById('detail-email').textContent = data.email;
        document.getElementById('balance').textContent = data.balance || 0;
        document.getElementById('total-used').textContent = data.total_used || 0;
        document.getElementById('created-at').textContent = formatDate(data.created_at);
        document.getElementById('last-login').textContent = formatDate(data.last_login);
        
        showUserInfo();
        
      } catch (error) {
        console.error('User info load error:', error);
        console.error('Error stack:', error.stack); // ÎîîÎ≤ÑÍπÖÏö©
        showError(`Unable to load information: ${error.message}`);
      }
    }
    
    // UI state functions
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';
      document.getElementById('user-info').style.display = 'none';
    }
    
    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('user-info').style.display = 'none';
      document.getElementById('error-message').textContent = message;
    }
    
    function showUserInfo() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('user-info').style.display = 'block';
    }
    
    // === Account Deletion Functions ===
    
    function showDeleteModal() {
      const email = getCurrentUserEmail();
      
      if (!email) {
        alert('‚ùå Login required. Please login first.');
        window.location.href = 'login.html';
        return;
      }
      
      const modal = document.getElementById('deleteModal');
      const confirmInput = document.getElementById('confirmInput');
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      
      // Reset modal state
      confirmInput.value = '';
      confirmInput.className = 'confirm-input';
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Delete My Account';
      
      // Show modal
      modal.style.display = 'block';
      
      // Focus on input after animation
      setTimeout(() => confirmInput.focus(), 300);
    }
    
    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
    }
    
    function validateDeleteInput() {
      const confirmInput = document.getElementById('confirmInput');
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      const inputValue = confirmInput.value.trim();
      
      if (inputValue === 'DELETE') {
        confirmInput.className = 'confirm-input valid';
        confirmBtn.disabled = false;
      } else {
        confirmInput.className = 'confirm-input';
        confirmBtn.disabled = true;
      }
    }
    
    async function confirmDelete() {
      const email = getCurrentUserEmail();
      const confirmInput = document.getElementById('confirmInput');
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      
      if (!email) {
        alert('‚ùå Login session expired. Please login again.');
        closeDeleteModal();
        window.location.href = 'login.html';
        return;
      }
      
      if (confirmInput.value.trim() !== 'DELETE') {
        alert('‚ùå Please type DELETE exactly as shown to confirm.');
        confirmInput.focus();
        return;
      }
      
      // Show loading state
      const originalText = confirmBtn.textContent;
      confirmBtn.textContent = '‚è≥ Deleting...';
      confirmBtn.disabled = true;
      
      try {
        console.log('Attempting to delete account for:', email);
        
        // Call backend API
        const response = await fetch('https://us-central1-deductive-ship-470913-d7.cloudfunctions.net/deleteAccount', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            email: email,
            timestamp: new Date().toISOString()
          })
        });
        
        console.log('Delete response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Delete error response:', errorText);
          throw new Error(`Server error (${response.status}): ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Delete response data:', data);
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        // Success - clear storage and redirect
        localStorage.removeItem('user_email');
        sessionStorage.removeItem('user_email');
        
        // Notify other tabs about logout
        window.dispatchEvent(new CustomEvent('authChanged'));
        
        alert('‚úÖ Account deleted successfully!\n\nYour data will be completely removed within 30 days.\nYou will now be redirected to the home page.');
        
        // Redirect to home page
        window.location.href = 'index.html';
        
      } catch (error) {
        console.error('Account deletion failed:', error);
        
        // Reset button state
        confirmBtn.textContent = originalText;
        confirmBtn.disabled = false;
        
        // Show user-friendly error message
        let errorMessage = 'Failed to delete account. ';
        if (error.message.includes('404')) {
          errorMessage += 'Account not found.';
        } else if (error.message.includes('500')) {
          errorMessage += 'Server error. Please try again later.';
        } else {
          errorMessage += error.message;
        }
        
        alert('‚ùå ' + errorMessage);
      }
    }
    
    // Auto load user info on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadUserInfo();
      
      // Set up delete confirmation input validation
      const confirmInput = document.getElementById('confirmInput');
      if (confirmInput) {
        confirmInput.addEventListener('input', validateDeleteInput);
        confirmInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && !document.getElementById('confirmDeleteBtn').disabled) {
            confirmDelete();
          }
        });
      }
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        const modal = document.getElementById('deleteModal');
        if (event.target === modal) {
          closeDeleteModal();
        }
      });
      
      // Close modal with Escape key
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          closeDeleteModal();
        }
      });
    });
  </script>
</body>
</html>
